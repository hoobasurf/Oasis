<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>OASIS v2</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:#000;overflow:hidden;font-family:'Rajdhani',sans-serif;color:#fff;cursor:none;touch-action:none;}
canvas{display:block;}

/* CUSTOM CURSOR */
#cur{position:fixed;width:24px;height:24px;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);transition:transform 0.1s;}
#cur::before{content:‚Äô‚Äô;position:absolute;inset:0;border:2px solid #00d4ff;border-radius:50%;box-shadow:0 0 12px #00d4ff,inset 0 0 6px rgba(0,212,255,0.3);animation:cp 1.5s ease-in-out infinite;}
#cur::after{content:‚Äô‚Äô;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:4px;height:4px;background:#00d4ff;border-radius:50%;box-shadow:0 0 8px #00d4ff;}
@keyframes cp{0%,100%{transform:scale(1);}50%{transform:scale(1.5);opacity:0.5;}}

/* HUD */
#hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:20;}

/* TOP BAR */
#topbar{position:absolute;top:0;left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,rgba(0,5,20,0.95) 0%,transparent 100%);}
.hb{display:flex;align-items:center;gap:8px;}
.hpbar{width:120px;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;border:1px solid rgba(255,80,80,0.3);}
.hpfill{height:100%;background:linear-gradient(90deg,#ff2244,#ff6688);border-radius:4px;transition:width 0.3s;box-shadow:0 0 8px #ff2244;}
.xpbar{width:80px;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;border:1px solid rgba(0,255,136,0.3);}
.xpfill{height:100%;background:linear-gradient(90deg,#00ff88,#00ffcc);border-radius:3px;transition:width 0.3s;box-shadow:0 0 8px #00ff88;}
.pill{background:rgba(0,10,30,0.85);border:1px solid rgba(0,200,255,0.35);border-radius:20px;padding:5px 12px;font-family:‚ÄòOrbitron‚Äô,monospace;font-size:11px;color:#00d4ff;text-shadow:0 0 8px #00d4ff;backdrop-filter:blur(8px);}
.pill span{color:#fff;}
#logo{font-family:‚ÄòOrbitron‚Äô,monospace;font-size:22px;font-weight:900;background:linear-gradient(90deg,#00d4ff,#ff00ff,#00ff88,#ffaa00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:5px;filter:drop-shadow(0 0 12px rgba(0,212,255,0.6));}

/* MINIMAP */
#mm{position:absolute;top:72px;right:12px;width:160px;height:160px;border-radius:12px;overflow:hidden;border:1px solid rgba(0,200,255,0.4);box-shadow:0 0 20px rgba(0,200,255,0.2);}
#mmCanvas{display:block;}

/* ZONE BANNER */
#zonebanner{position:absolute;top:72px;left:50%;transform:translateX(-50%);font-family:‚ÄòOrbitron‚Äô,monospace;font-size:13px;letter-spacing:3px;color:rgba(255,255,255,0.5);text-shadow:0 0 10px currentColor;transition:color 0.5s;}

/* NOTIFICATION */
#notif{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-family:‚ÄòOrbitron‚Äô,monospace;font-size:22px;font-weight:900;text-align:center;opacity:0;transition:opacity 0.3s;pointer-events:none;text-shadow:0 0 30px currentColor;line-height:1.4;}

/* JOYSTICK */
#joystickZone{position:absolute;bottom:30px;left:30px;width:140px;height:140px;pointer-events:all;}
#jBase{position:absolute;inset:0;border-radius:50%;background:rgba(0,20,50,0.6);border:2px solid rgba(0,200,255,0.3);box-shadow:0 0 20px rgba(0,200,255,0.15);}
#jStick{position:absolute;width:52px;height:52px;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(0,212,255,0.9),rgba(0,80,160,0.9));border:2px solid rgba(0,212,255,0.8);box-shadow:0 0 15px rgba(0,212,255,0.6);transition:box-shadow 0.1s;}

/* ACTION BUTTONS */
#actionBtns{position:absolute;bottom:30px;right:20px;display:flex;flex-direction:column;gap:10px;pointer-events:all;}
.abtn{width:54px;height:54px;border-radius:50%;border:none;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;-webkit-tap-highlight-color:transparent;}
.abtn:active{transform:scale(0.88);}
#btnSprint{background:radial-gradient(circle,#ff6600,#aa3300);box-shadow:0 0 15px rgba(255,100,0,0.6);border:2px solid rgba(255,150,0,0.6);}
#btnInteract{background:radial-gradient(circle,#00aa55,#005522);box-shadow:0 0 15px rgba(0,200,80,0.6);border:2px solid rgba(0,255,100,0.6);}
#btnCustom{background:radial-gradient(circle,#aa00ff,#440088);box-shadow:0 0 15px rgba(170,0,255,0.6);border:2px solid rgba(200,100,255,0.6);}

/* CHAR CUSTOMIZER */
#customizer{position:fixed;inset:0;background:rgba(0,5,20,0.96);display:none;z-index:50;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(10px);}
#customizer.open{display:flex;}
#custTitle{font-family:‚ÄòOrbitron‚Äô,monospace;font-size:28px;font-weight:900;background:linear-gradient(135deg,#00d4ff,#ff00ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:30px;letter-spacing:4px;}
#charPreview{width:120px;height:180px;position:relative;margin-bottom:30px;}
#custOptions{display:flex;flex-wrap:wrap;gap:16px;justify-content:center;max-width:500px;margin-bottom:24px;}
.custSection{background:rgba(0,20,50,0.7);border:1px solid rgba(0,200,255,0.3);border-radius:12px;padding:14px 18px;min-width:200px;}
.custSection h3{font-family:‚ÄòOrbitron‚Äô,monospace;font-size:11px;color:rgba(255,255,255,0.4);letter-spacing:2px;margin-bottom:10px;}
.colorPicker{display:flex;gap:8px;flex-wrap:wrap;}
.cBtn{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all 0.2s;}
.cBtn.sel{border-color:#fff;transform:scale(1.2);box-shadow:0 0 10px currentColor;}
.shapeRow{display:flex;gap:8px;}
.sBtn{padding:6px 12px;background:rgba(0,30,60,0.8);border:1px solid rgba(0,200,255,0.3);border-radius:8px;color:#00d4ff;font-family:‚ÄòOrbitron‚Äô,monospace;font-size:10px;cursor:pointer;transition:all 0.2s;}
.sBtn.sel{background:rgba(0,100,200,0.5);border-color:#00d4ff;box-shadow:0 0 8px #00d4ff;}
#closeCustom{background:linear-gradient(135deg,#00d4ff,#0066ff);border:none;border-radius:12px;padding:12px 40px;font-family:‚ÄòOrbitron‚Äô,monospace;font-size:14px;font-weight:700;color:#000;cursor:pointer;letter-spacing:2px;}

/* START SCREEN */
#startScreen{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;}
#startBg{position:absolute;inset:0;}
#startContent{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;}
#sTitle{font-family:‚ÄòOrbitron‚Äô,monospace;font-size:clamp(40px,10vw,80px);font-weight:900;background:linear-gradient(135deg,#00d4ff 0%,#ff00ff 40%,#00ff88 70%,#ffaa00 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:8px;margin-bottom:8px;animation:tg 3s ease-in-out infinite alternate;}
@keyframes tg{from{filter:brightness(1) drop-shadow(0 0 20px #00d4ff);}to{filter:brightness(1.4) drop-shadow(0 0 50px #ff00ff);}}
#sSub{font-size:clamp(12px,3vw,18px);color:rgba(255,255,255,0.4);letter-spacing:8px;margin-bottom:50px;font-family:‚ÄòOrbitron‚Äô,monospace;}
.sForm{display:flex;flex-direction:column;align-items:center;gap:16px;width:min(320px,85vw);}
#sName{background:rgba(0,15,40,0.9);border:2px solid rgba(0,200,255,0.5);border-radius:14px;padding:14px 20px;font-family:‚ÄòOrbitron‚Äô,monospace;font-size:16px;color:#00d4ff;text-align:center;outline:none;width:100%;box-shadow:0 0 20px rgba(0,212,255,0.2),inset 0 0 20px rgba(0,212,255,0.05);}
#sName::placeholder{color:rgba(0,212,255,0.3);}
.colorPick{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
.cpBtn{width:34px;height:34px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.2s;}
.cpBtn.sel{border-color:#fff;transform:scale(1.25);box-shadow:0 0 12px currentColor;}
#sBtn{background:linear-gradient(135deg,#00d4ff,#0055ff);border:none;border-radius:14px;padding:16px 60px;font-family:‚ÄòOrbitron‚Äô,monospace;font-size:16px;font-weight:700;color:#000;cursor:pointer;letter-spacing:3px;box-shadow:0 0 30px rgba(0,212,255,0.5);transition:all 0.3s;width:100%;}
#sBtn:active{transform:scale(0.96);}
.features{display:flex;gap:clamp(10px,3vw,30px);margin-top:40px;flex-wrap:wrap;justify-content:center;}
.feat{display:flex;align-items:center;gap:6px;font-size:12px;color:rgba(255,255,255,0.3);letter-spacing:1px;}
.fdot{width:7px;height:7px;border-radius:50%;}
</style>

</head>
<body>
<div id="cur"></div>

<!-- START SCREEN -->

<div id="startScreen">
  <canvas id="startBg"></canvas>
  <div id="startContent">
    <div id="sTitle">OASIS</div>
    <div id="sSub">MONDE SANS LIMITES ¬∑ V2</div>
    <div class="sForm">
      <input id="sName" type="text" placeholder="TON PSEUDO..." maxlength="14" />
      <div style="font-family:Orbitron,monospace;font-size:11px;color:rgba(0,212,255,0.5);letter-spacing:2px;">COULEUR DE TON PERSO</div>
      <div class="colorPick" id="startColors"></div>
      <button id="sBtn" onclick="startGame()">‚ö° ENTRER DANS L'OASIS</button>
    </div>
    <div class="features">
      <div class="feat"><div class="fdot" style="background:#00d4ff;box-shadow:0 0 8px #00d4ff"></div>MONDE 3D</div>
      <div class="feat"><div class="fdot" style="background:#ff00ff;box-shadow:0 0 8px #ff00ff"></div>MOBILE OK</div>
      <div class="feat"><div class="fdot" style="background:#00ff88;box-shadow:0 0 8px #00ff88"></div>LIBRE</div>
      <div class="feat"><div class="fdot" style="background:#ffaa00;box-shadow:0 0 8px #ffaa00"></div>√âVOLUTION</div>
    </div>
  </div>
</div>

<!-- GAME CANVAS -->

<canvas id="gameCanvas"></canvas>

<!-- HUD -->

<div id="hud">
  <div id="topbar">
    <div class="hb" style="flex-direction:column;gap:4px;align-items:flex-start;">
      <div class="hb">
        <span style="font-size:10px;color:rgba(255,80,80,0.8);font-family:Orbitron,monospace;">HP</span>
        <div class="hpbar"><div class="hpfill" id="hpFill" style="width:100%"></div></div>
        <span id="hpVal" style="font-family:Orbitron,monospace;font-size:10px;color:#ff6688;">100</span>
      </div>
      <div class="hb">
        <span style="font-size:10px;color:rgba(0,255,136,0.8);font-family:Orbitron,monospace;">XP</span>
        <div class="xpbar"><div class="xpfill" id="xpFill" style="width:0%"></div></div>
        <span id="lvlVal" style="font-family:Orbitron,monospace;font-size:10px;color:#00ff88;">LV1</span>
      </div>
    </div>
    <div id="logo">OASIS</div>
    <div class="pill">üí∞ <span id="goldVal">500</span></div>
  </div>

  <div id="mm"><canvas id="mmCanvas" width="160" height="160"></canvas></div>
  <div id="zonebanner" id="zonebanner">‚óè HUB CENTRAL</div>
  <div id="notif"></div>

  <!-- JOYSTICK -->

  <div id="joystickZone">
    <div id="jBase"></div>
    <div id="jStick"></div>
  </div>

  <!-- ACTION BUTTONS -->

  <div id="actionBtns">
    <button class="abtn" id="btnCustom" title="Personnage">üé®</button>
    <button class="abtn" id="btnInteract" title="Interagir">üí¨</button>
    <button class="abtn" id="btnSprint" title="Sprint">‚ö°</button>
  </div>
</div>

<!-- CUSTOMIZER -->

<div id="customizer">
  <div id="custTitle">TON AVATAR</div>
  <canvas id="charPreviewCanvas" width="120" height="180"></canvas>
  <div id="custOptions">
    <div class="custSection">
      <h3>COULEUR CORPS</h3>
      <div class="colorPicker" id="bodyColors"></div>
    </div>
    <div class="custSection">
      <h3>COULEUR AURA</h3>
      <div class="colorPicker" id="auraColors"></div>
    </div>
    <div class="custSection">
      <h3>FORME</h3>
      <div class="shapeRow" id="shapes"></div>
    </div>
    <div class="custSection">
      <h3>ACCESSOIRE</h3>
      <div class="shapeRow" id="accessories"></div>
    </div>
  </div>
  <button id="closeCustom" onclick="closeCustomizer()">CONFIRMER</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mmCanvas = document.getElementById('mmCanvas');
const mmCtx = mmCanvas.getContext('2d');
const startBg = document.getElementById('startBg');
const sbCtx = startBg.getContext('2d');

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  startBg.width = window.innerWidth;
  startBg.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

// Cursor
const curEl = document.getElementById('cur');
document.addEventListener('mousemove', e => { curEl.style.left=e.clientX+'px'; curEl.style.top=e.clientY+'px'; });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PALETTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLORS = {
  player: ['#00d4ff','#ff00ff','#00ff88','#ffaa00','#ff4466','#ffffff','#aa44ff','#ff6600'],
  aura:   ['#00d4ff','#ff00ff','#00ff88','#ffaa00','#ff0044','#8844ff','#00ffff','#ff4400'],
};
const SHAPES = ['carr√©','rond','diamant'];
const ACCS = ['aucun','couronne','ailes','casque'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const G = {
  playerName: 'Player',
  hp: 100, maxHp: 100,
  gold: 500,
  xp: 0, lvl: 1,
  avatar: { color:'#00d4ff', aura:'#00d4ff', shape:'carr√©', acc:'aucun' },
  running: false,
  sprint: false,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WW=4000, WH=4000;
const TILE=64;
const ISO_SCALE=0.5; // isometric tilt

// Camera
const cam={x:WW/2-400, y:WH/2-300, targetX:0, targetY:0};

// Player
const player={
  x:WW/2, y:WH/2,
  vx:0, vy:0,
  w:28,h:28,
  baseSpeed:3.8,
  trail:[],
};

// Joystick state
const joy={active:false,startX:0,startY:0,dx:0,dy:0,id:-1};

// Keys
const keys={};
document.addEventListener('keydown', e=>{ keys[e.code]=true; });
document.addEventListener('keyup',   e=>{ keys[e.code]=false; });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZONES (isometric)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const zones=[
  {name:'HUB CENTRAL',    x:1600,y:1600,w:800,h:800, floorColor:'#001530', wallColor:'#002050', borderColor:'#00d4ff',  accent:'#00d4ff', label:'üåê Hub Central'},
  {name:'NEON CITY',      x:200, y:200, w:1200,h:800, floorColor:'#1a0025', wallColor:'#2d0040', borderColor:'#ff00ff', accent:'#ff00ff', label:'üèôÔ∏è Neon City'},
  {name:'ZONE COMBAT',    x:2600,y:200, w:1000,h:900, floorColor:'#200000', wallColor:'#380000', borderColor:'#ff3300', accent:'#ff3300', label:'‚öîÔ∏è Zone Combat'},
  {name:'OCEAN PIXEL',    x:100, y:2600,w:1300,h:900, floorColor:'#001520', wallColor:'#002030', borderColor:'#00ffcc', accent:'#00ffcc', label:'üåä Ocean Pixel'},
  {name:'GROTTE DES CODES',x:2700,y:2400,w:800,h:700, floorColor:'#001a00', wallColor:'#002a00', borderColor:'#00ff44', accent:'#00ff44', label:'üíª Grotte Codes'},
  {name:'D√âSERT DE SABLE', x:1300,y:2900,w:1100,h:900, floorColor:'#1a0d00', wallColor:'#2a1400', borderColor:'#ffaa00', accent:'#ffaa00', label:'üèúÔ∏è D√©sert de Sable'},
];

// Buildings
const buildings=[];
// NPCs
const npcs=[];
// Collectibles
const collectibles=[];
// Particles
const particles=[];
// Floating texts
const floatTexts=[];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ISO HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Convert world XY to isometric screen XY
function isoProject(wx, wy, wz=0){
  // isometric projection
  const sx = (wx - wy) * Math.cos(Math.PI/6);
  const sy = (wx + wy) * Math.sin(Math.PI/6) - wz * 0.8;
  return {sx, sy};
}

// Get screen pos relative to camera
function toScreen(wx, wy, wz=0){
  const p = isoProject(wx, wy, wz);
  return {
    x: p.sx - isoProject(cam.x, cam.y).sx + canvas.width/2,
    y: p.sy - isoProject(cam.x, cam.y).sy + canvas.height/2
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initWorld(){
  // Hub buildings
  const hubDefs=[
    {x:1680,y:1680,w:60,h:60,h3:120,zone:'hub'},
    {x:1780,y:1700,w:50,h:80,h3:90,zone:'hub'},
    {x:1900,y:1680,w:70,h:50,h3:150,zone:'hub'},
    {x:2100,y:1750,w:55,h:65,h3:100,zone:'hub'},
    {x:2000,y:1900,w:80,h:80,h3:200,zone:'hub'},
    {x:1700,y:2000,w:65,h:55,h3:80, zone:'hub'},
    {x:2200,y:1900,w:45,h:45,h3:60, zone:'hub'},
    {x:1850,y:2100,w:90,h:60,h3:130,zone:'hub'},
  ];
  hubDefs.forEach(b=>{
    buildings.push({...b, color:'#001540', wallL:'#00205a', wallR:'#001a4a', border:'#003399', accent:'#00d4ff'});
  });

  // Neon city buildings
  for(let i=0;i<20;i++){
    buildings.push({
      x:250+Math.random()*1100, y:250+Math.random()*700,
      w:30+Math.random()*70, h:30+Math.random()*70,
      h3: 60+Math.random()*200,
      color:'#15002a', wallL:'#220040', wallR:'#1a0035', border:'#660099', accent:`hsl(${280+Math.random()*80},100%,65%)`,
      zone:'neon'
    });
  }

  // Combat zone rocks/obstacles
  for(let i=0;i<14;i++){
    buildings.push({
      x:2650+Math.random()*900, y:250+Math.random()*800,
      w:20+Math.random()*60, h:20+Math.random()*60,
      h3:20+Math.random()*60,
      color:'#1f0000', wallL:'#2a0000', wallR:'#200000', border:'#550000', accent:'#ff3300',
      zone:'combat'
    });
  }

  // NPCs
  [
    {x:2020,y:1900, name:'Marchande Zara', color:'#ff00ff', aura:'#ff00ff', dialog:'üõí Bienvenue ! J\'ach√®te et vends des items rares.', reward:30},
    {x:1850,y:2050, name:'Hacker Rex',     color:'#00ff44', aura:'#00ff44', dialog:'üíª Je connais des passages secrets dans le code...', reward:50},
    {x:2150,y:1850, name:'Guerrier Kaz',   color:'#ff4400', aura:'#ff4400', dialog:'‚öîÔ∏è La Zone Combat n\'attend que toi, combattant !', reward:20},
    {x:650,  y:600,  name:'DJ Ghost',       color:'#aa00ff', aura:'#aa00ff', dialog:'üéµ Tu sens cette fr√©quence ? C\'est Neon City qui pulse !', reward:15},
    {x:3050, y:600,  name:'Bounty Rex',     color:'#ff0022', aura:'#ff0000', dialog:'üéØ M√©fie-toi des ombres ici, √©tranger.', reward:40},
    {x:800,  y:3100, name:'Capitaine Blue', color:'#00ffcc', aura:'#00ffcc', dialog:'üåä L\'Ocean Pixel cache des tr√©sors en profondeur !', reward:35},
  ].forEach(n=>npcs.push({...n, w:22, h:22, talking:false, talkTimer:0, bobOffset:Math.random()*Math.PI*2}));

  // Collectibles
  for(let i=0;i<60;i++){
    collectibles.push({
      x:300+Math.random()*3400, y:300+Math.random()*3400,
      type:Math.random()>0.4?'gold':'xp',
      value:Math.floor(10+Math.random()*50),
      collected:false, pulse:Math.random()*Math.PI*2
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAW HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawIsoTile(wx,wy, tw,th, topColor, leftColor, rightColor, borderColor, height=0){
  const tl = toScreen(wx,     wy,     height);
  const tr = toScreen(wx+tw,  wy,     height);
  const br = toScreen(wx+tw,  wy+th,  height);
  const bl = toScreen(wx,     wy+th,  height);

  // Top face
  ctx.beginPath();
  ctx.moveTo(tl.x,tl.y); ctx.lineTo(tr.x,tr.y);
  ctx.lineTo(br.x,br.y); ctx.lineTo(bl.x,bl.y);
  ctx.closePath();
  ctx.fillStyle = topColor;
  ctx.fill();
  if(borderColor){ ctx.strokeStyle=borderColor; ctx.lineWidth=0.5; ctx.stroke(); }
}

function drawIsoBox(wx,wy, bw,bd, bh, topC, leftC, rightC, accentC){
  const tl = toScreen(wx,    wy,    bh);
  const tr = toScreen(wx+bw, wy,    bh);
  const br = toScreen(wx+bw, wy+bd, bh);
  const bl = toScreen(wx,    wy+bd, bh);
  const btl= toScreen(wx,    wy,    0);
  const btr= toScreen(wx+bw, wy,    0);
  const bbr= toScreen(wx+bw, wy+bd, 0);
  const bbl= toScreen(wx,    wy+bd, 0);

  // Left face
  ctx.beginPath(); ctx.moveTo(tl.x,tl.y); ctx.lineTo(bl.x,bl.y); ctx.lineTo(bbl.x,bbl.y); ctx.lineTo(btl.x,btl.y); ctx.closePath();
  ctx.fillStyle=leftC; ctx.fill();
  // Right face
  ctx.beginPath(); ctx.moveTo(tr.x,tr.y); ctx.lineTo(br.x,br.y); ctx.lineTo(bbr.x,bbr.y); ctx.lineTo(btr.x,btr.y); ctx.closePath();
  ctx.fillStyle=rightC; ctx.fill();
  // Top face
  ctx.beginPath(); ctx.moveTo(tl.x,tl.y); ctx.lineTo(tr.x,tr.y); ctx.lineTo(br.x,br.y); ctx.lineTo(bl.x,bl.y); ctx.closePath();
  ctx.fillStyle=topC; ctx.fill();

  // Accent border
  ctx.strokeStyle=accentC; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(tl.x,tl.y); ctx.lineTo(tr.x,tr.y); ctx.lineTo(br.x,br.y); ctx.lineTo(bl.x,bl.y); ctx.closePath(); ctx.stroke();

  // Window lights
  const numW = Math.floor(bh/30);
  for(let i=0;i<numW;i++){
    const h2 = (i+0.5)*(bh/numW);
    if(Math.random()>0.3){
      const wl = toScreen(wx+2,wy+bd,h2);
      const wr = toScreen(wx,  wy+bd,h2);
      ctx.fillStyle=`rgba(${hexToRgb(accentC)},${0.4+Math.random()*0.4})`;
      ctx.fillRect(wl.x-3,wl.y-3,6,4);
    }
  }
}

function hexToRgb(hex){
  const r=parseInt(hex.slice(1,3),16);
  const g=parseInt(hex.slice(3,5),16);
  const b=parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAW WORLD FLOOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawFloor(){
  // Draw zones floor
  zones.forEach(z=>{
    // Floor
    drawIsoTile(z.x,z.y,z.w,z.h, z.floorColor, z.wallColor, z.wallColor, z.borderColor+'44');
    // Zone border wall (thin)
    // Left edge
    const tl=toScreen(z.x,z.y,0), bl=toScreen(z.x,z.y+z.h,0);
    const tl2=toScreen(z.x,z.y,12), bl2=toScreen(z.x,z.y+z.h,12);
    ctx.beginPath(); ctx.moveTo(tl2.x,tl2.y); ctx.lineTo(bl2.x,bl2.y); ctx.lineTo(bl.x,bl.y); ctx.lineTo(tl.x,tl.y); ctx.closePath();
    ctx.fillStyle=z.wallColor; ctx.fill();
    ctx.strokeStyle=z.borderColor; ctx.lineWidth=1; ctx.stroke();
  });

  // Grid tiles outside zones
  const gStep=TILE;
  const camP=isoProject(cam.x,cam.y);
  const viewR=Math.ceil(canvas.width/gStep)+4;
  const viewC=Math.ceil(canvas.height/gStep)+4;
  
  for(let r=-2;r<viewR;r++){
    for(let c=-2;c<viewC;c++){
      const wx=cam.x + r*gStep - (c*gStep*0.5);
      const wy=cam.y + c*gStep*0.5;
      if(wx<0||wx>WW||wy<0||wy>WH) continue;
      const inZone=zones.some(z=>wx>z.x&&wx<z.x+z.w&&wy>z.y&&wy<z.y+z.h);
      if(!inZone){
        drawIsoTile(wx,wy,gStep,gStep,'#020810','#010608','#010608','rgba(0,80,160,0.08)');
      }
    }
  }
}

function drawZoneLabels(){
  zones.forEach(z=>{
    const center=toScreen(z.x+z.w/2, z.y+z.h/2, 20);
    ctx.fillStyle=z.accent;
    ctx.font='bold 12px Orbitron';
    ctx.textAlign='center';
    ctx.shadowColor=z.accent; ctx.shadowBlur=12;
    ctx.fillText(z.label, center.x, center.y);
    ctx.shadowBlur=0;
    ctx.textAlign='left';
  });
}

function drawBuildings(){
  // Sort by depth for correct iso drawing
  const sorted=[...buildings].sort((a,b)=>(a.x+a.y)-(b.x+b.y));
  sorted.forEach(b=>{
    const s=toScreen(b.x,b.y,0);
    if(s.x<-300||s.x>canvas.width+300||s.y<-300||s.y>canvas.height+300) return;
    ctx.shadowColor=b.accent; ctx.shadowBlur=8;
    drawIsoBox(b.x,b.y,b.w,b.h,b.h3, b.color, b.wallL, b.wallR, b.accent);
    ctx.shadowBlur=0;
  });
}

function drawCollectibles(t){
  collectibles.forEach(c=>{
    if(c.collected) return;
    c.pulse+=0.04;
    const bob=Math.sin(c.pulse)*4;
    const s=toScreen(c.x,c.y,10+bob);
    if(s.x<-50||s.x>canvas.width+50||s.y<-50||s.y>canvas.height+50) return;

    const color=c.type==='gold'?'#ffcc00':'#00ff88';
    ctx.shadowColor=color; ctx.shadowBlur=20;
    ctx.fillStyle=color;
    ctx.beginPath(); ctx.arc(s.x,s.y,8,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    ctx.fillStyle='#000';
    ctx.font='10px sans-serif';
    ctx.textAlign='center';
    ctx.fillText(c.type==='gold'?'üí∞':'‚≠ê',s.x,s.y+4);
    ctx.textAlign='left';

    // Collection check
    const dx=player.x-c.x, dy=player.y-c.y;
    if(Math.sqrt(dx*dx+dy*dy)<30){
      c.collected=true;
      if(c.type==='gold'){
        G.gold+=c.value;
        document.getElementById('goldVal').textContent=G.gold;
        spawnFloat(s.x,s.y,`+${c.value}üí∞`,'#ffcc00');
        spawnParticles(s.x,s.y,color,10);
      } else {
        G.xp+=c.value;
        spawnFloat(s.x,s.y,`+${c.value}XP`,'#00ff88');
        spawnParticles(s.x,s.y,color,10);
        checkLvlUp();
      }
    }
  });
}

function drawNPCs(t){
  npcs.forEach(npc=>{
    const bob=Math.sin(t*0.002+npc.bobOffset)*5;
    const s=toScreen(npc.x,npc.y,20+bob);
    if(s.x<-100||s.x>canvas.width+100) return;

    ctx.shadowColor=npc.aura; ctx.shadowBlur=25;
    ctx.fillStyle=npc.color;
    ctx.fillRect(s.x-11,s.y-11,22,22);
    // Head circle
    ctx.beginPath(); ctx.arc(s.x,s.y-18,8,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;

    // Name
    ctx.fillStyle=npc.color;
    ctx.font='bold 10px Orbitron';
    ctx.textAlign='center';
    ctx.fillText(npc.name,s.x,s.y-32);

    // Proximity
    const dx=player.x-npc.x, dy=player.y-npc.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<90){
      ctx.fillStyle='rgba(255,255,255,0.9)';
      ctx.font='9px Orbitron';
      ctx.fillText('[E] Parler',s.x,s.y+26);
      if(keys['KeyE']&&!npc.talking){
        npc.talking=true; npc.talkTimer=240;
        showNotif(npc.dialog, npc.color);
        if(npc.reward){
          G.gold+=npc.reward;
          document.getElementById('goldVal').textContent=G.gold;
          spawnFloat(s.x,s.y-50,`+${npc.reward}üí∞`,'#ffcc00');
        }
      }
    }
    ctx.textAlign='left';
    if(npc.talkTimer>0) npc.talkTimer--;
    else npc.talking=false;
  });
}

function drawPlayer(t){
  const s=toScreen(player.x,player.y,0);

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.4)';
  ctx.beginPath(); ctx.ellipse(s.x,s.y+6,14,6,0,0,Math.PI*2); ctx.fill();

  // Trail
  player.trail.push({x:s.x,y:s.y});
  if(player.trail.length>20) player.trail.shift();
  player.trail.forEach((pt,i)=>{
    const a=(i/player.trail.length)*0.6;
    const sz=(i/player.trail.length)*10;
    ctx.fillStyle=G.sprint?`rgba(255,100,0,${a})`:`rgba(${hexToRgb(G.avatar.aura)},${a})`;
    ctx.beginPath(); ctx.arc(pt.x,pt.y,sz,0,Math.PI*2); ctx.fill();
  });

  // Aura glow
  const grad=ctx.createRadialGradient(s.x,s.y-10,0,s.x,s.y-10,40);
  grad.addColorStop(0,G.avatar.aura+'66');
  grad.addColorStop(1,'transparent');
  ctx.fillStyle=grad;
  ctx.beginPath(); ctx.arc(s.x,s.y-10,40,0,Math.PI*2); ctx.fill();

  // Body
  ctx.shadowColor=G.avatar.aura; ctx.shadowBlur=30;
  ctx.fillStyle=G.avatar.color;
  const bobPl=Math.sin(t*0.015)*2;

  if(G.avatar.shape==='carr√©'){
    ctx.fillRect(s.x-12,s.y-28+bobPl,24,24);
  } else if(G.avatar.shape==='rond'){
    ctx.beginPath(); ctx.arc(s.x,s.y-16+bobPl,13,0,Math.PI*2); ctx.fill();
  } else if(G.avatar.shape==='diamant'){
    ctx.save(); ctx.translate(s.x,s.y-16+bobPl); ctx.rotate(Math.PI/4); ctx.fillRect(-10,-10,20,20); ctx.restore();
  }

  // Head
  ctx.fillStyle=lightenColor(G.avatar.color,30);
  ctx.beginPath(); ctx.arc(s.x,s.y-38+bobPl,9,0,Math.PI*2); ctx.fill();

  // Eyes
  ctx.fillStyle='#000';
  ctx.fillRect(s.x-5,s.y-41+bobPl,4,4);
  ctx.fillRect(s.x+1,s.y-41+bobPl,4,4);

  // Accessory
  drawAcc(s.x,s.y-48+bobPl);

  ctx.shadowBlur=0;

  // Name
  ctx.fillStyle='rgba(255,255,255,0.9)';
  ctx.font='bold 10px Orbitron';
  ctx.textAlign='center';
  ctx.fillText(G.playerName,s.x,s.y-56+bobPl);
  ctx.textAlign='left';
}

function drawAcc(x,y){
  if(G.avatar.acc==='couronne'){
    ctx.fillStyle='#ffdd00';
    ctx.shadowColor='#ffdd00'; ctx.shadowBlur=10;
    ctx.beginPath(); ctx.moveTo(x-10,y); ctx.lineTo(x-10,y-8); ctx.lineTo(x-5,y-4); ctx.lineTo(x,y-10); ctx.lineTo(x+5,y-4); ctx.lineTo(x+10,y-8); ctx.lineTo(x+10,y); ctx.closePath(); ctx.fill();
  } else if(G.avatar.acc==='ailes'){
    ctx.fillStyle=G.avatar.aura+'aa';
    ctx.shadowColor=G.avatar.aura; ctx.shadowBlur=15;
    ctx.beginPath(); ctx.moveTo(x,y); ctx.bezierCurveTo(x-30,y-20,x-40,y+10,x-20,y+5); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(x,y); ctx.bezierCurveTo(x+30,y-20,x+40,y+10,x+20,y+5); ctx.closePath(); ctx.fill();
  } else if(G.avatar.acc==='casque'){
    ctx.fillStyle='#888'; ctx.shadowColor='#aaa'; ctx.shadowBlur=8;
    ctx.beginPath(); ctx.arc(x,y,10,Math.PI,0); ctx.fill();
    ctx.fillStyle=G.avatar.aura;
    ctx.fillRect(x-2,y-12,4,6);
  }
}

function lightenColor(hex,pct){
  const r=Math.min(255,parseInt(hex.slice(1,3),16)+pct);
  const g=Math.min(255,parseInt(hex.slice(3,5),16)+pct);
  const b=Math.min(255,parseInt(hex.slice(5,7),16)+pct);
  return `rgb(${r},${g},${b})`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARTICLES & FLOATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnParticles(x,y,color,n){
  for(let i=0;i<n;i++){
    const a=(Math.PI*2/n)*i;
    particles.push({x,y,vx:Math.cos(a)*(2+Math.random()*4),vy:Math.sin(a)*(2+Math.random()*4)-2,color,life:50,maxLife:50,r:2+Math.random()*3});
  }
}
function spawnFloat(x,y,text,color){
  floatTexts.push({x,y,text,color,life:90,maxLife:90,vy:-1.5});
}
function drawParticles(){
  particles.forEach((p,i)=>{
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.vx*=0.94; p.life--;
    const a=p.life/p.maxLife;
    ctx.globalAlpha=a;
    ctx.fillStyle=p.color; ctx.shadowColor=p.color; ctx.shadowBlur=8;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1; ctx.shadowBlur=0;
  });
  for(let i=particles.length-1;i>=0;i--) if(particles[i].life<=0) particles.splice(i,1);
}
function drawFloatTexts(){
  floatTexts.forEach(f=>{
    f.y+=f.vy; f.life--;
    const a=f.life/f.maxLife;
    ctx.globalAlpha=a;
    ctx.fillStyle=f.color; ctx.font='bold 14px Orbitron'; ctx.textAlign='center';
    ctx.shadowColor=f.color; ctx.shadowBlur=10;
    ctx.fillText(f.text,f.x,f.y);
    ctx.globalAlpha=1; ctx.shadowBlur=0; ctx.textAlign='left';
  });
  for(let i=floatTexts.length-1;i>=0;i--) if(floatTexts[i].life<=0) floatTexts.splice(i,1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MINIMAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawMinimap(){
  const sc=160/WW;
  mmCtx.fillStyle='#000a1a'; mmCtx.fillRect(0,0,160,160);
  zones.forEach(z=>{
    mmCtx.fillStyle=z.floorColor;
    mmCtx.fillRect(z.x*sc,z.y*sc,z.w*sc,z.h*sc);
    mmCtx.strokeStyle=z.borderColor; mmCtx.lineWidth=1;
    mmCtx.strokeRect(z.x*sc,z.y*sc,z.w*sc,z.h*sc);
  });
  npcs.forEach(n=>{
    mmCtx.fillStyle=n.color;
    mmCtx.fillRect(n.x*sc-2,n.y*sc-2,4,4);
  });
  collectibles.filter(c=>!c.collected).forEach(c=>{
    mmCtx.fillStyle=c.type==='gold'?'#ffcc00':'#00ff88';
    mmCtx.fillRect(c.x*sc-1,c.y*sc-1,2,2);
  });
  const px=player.x*sc, py=player.y*sc;
  mmCtx.fillStyle='#fff'; mmCtx.shadowColor=G.avatar.aura; mmCtx.shadowBlur=8;
  mmCtx.fillRect(px-3,py-3,6,6);
  mmCtx.shadowBlur=0;
  mmCtx.strokeStyle='rgba(0,200,255,0.5)'; mmCtx.lineWidth=2;
  mmCtx.strokeRect(0,0,160,160);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notifTimer=0;
function showNotif(text,color='#00d4ff'){
  const el=document.getElementById('notif');
  el.innerHTML=text; el.style.color=color; el.style.opacity='1';
  notifTimer=200;
}
function tickNotif(){
  if(notifTimer>0){
    notifTimer--;
    const el=document.getElementById('notif');
    if(notifTimer<50) el.style.opacity=(notifTimer/50).toString();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// XP / LVL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkLvlUp(){
  const needed=G.lvl*100;
  if(G.xp>=needed){
    G.xp-=needed; G.lvl++;
    document.getElementById('lvlVal').textContent='LV'+G.lvl;
    showNotif(`üéâ LEVEL UP ! NIVEAU ${G.lvl}`, '#00ff88');
    spawnParticles(canvas.width/2,canvas.height/2,'#00ff88',20);
    spawnParticles(canvas.width/2,canvas.height/2,'#ffcc00',20);
  }
  document.getElementById('xpFill').style.width=(G.xp/(G.lvl*100)*100)+'%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCurrentZone(){
  return zones.find(z=>player.x>z.x&&player.x<z.x+z.w&&player.y>z.y&&player.y<z.y+z.h)||null;
}
let lastZone=null;

function updatePlayer(){
  let dx=0, dy=0;

  // Keyboard
  if(keys['KeyZ']||keys['ArrowUp'])    dy-=1;
  if(keys['KeyS']||keys['ArrowDown'])  dy+=1;
  if(keys['KeyQ']||keys['ArrowLeft'])  dx-=1;
  if(keys['KeyD']||keys['ArrowRight']) dx+=1;

  // Joystick
  if(joy.active){
    const mag=Math.sqrt(joy.dx*joy.dx+joy.dy*joy.dy);
    if(mag>8){
      dx+=joy.dx/mag;
      dy+=joy.dy/mag;
    }
  }

  G.sprint=keys['KeyF']||keys['ShiftLeft']||sprintHeld;
  const spd=G.sprint ? player.baseSpeed*1.8 : player.baseSpeed;

  if(dx!==0&&dy!==0){ dx*=0.707; dy*=0.707; }

  player.x=Math.max(50,Math.min(WW-50,player.x+dx*spd));
  player.y=Math.max(50,Math.min(WH-50,player.y+dy*spd));

  // Smooth camera
  cam.x+=(player.x-canvas.width/2 - cam.x)*0.08;
  cam.y+=(player.y-canvas.height/2 - cam.y)*0.08;
  cam.x=Math.max(0,Math.min(WW-canvas.width,cam.x));
  cam.y=Math.max(0,Math.min(WH-canvas.height,cam.y));

  // Zone change
  const z=getCurrentZone();
  if(z!==lastZone){
    lastZone=z;
    const zname=z?z.name:'ZONE SAUVAGE';
    document.getElementById('zonebanner').textContent='‚óè '+zname;
    document.getElementById('zonebanner').style.color=z?z.accent:'rgba(255,255,255,0.4)';
    if(z) showNotif('üìç '+z.label, z.accent);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE JOYSTICK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const jZone=document.getElementById('joystickZone');
const jStick=document.getElementById('jStick');
const JR=65; // max radius

function joyStart(e){
  e.preventDefault();
  const t=e.touches?e.touches[0]:e;
  const rect=jZone.getBoundingClientRect();
  joy.active=true;
  joy.startX=rect.left+rect.width/2;
  joy.startY=rect.top+rect.height/2;
  joy.id=e.touches?e.touches[0].identifier:-1;
}
function joyMove(e){
  e.preventDefault();
  if(!joy.active) return;
  let t=e.touches?[...e.touches].find(x=>x.identifier===joy.id):e;
  if(!t) return;
  joy.dx=t.clientX-joy.startX;
  joy.dy=t.clientY-joy.startY;
  const mag=Math.sqrt(joy.dx*joy.dx+joy.dy*joy.dy);
  const clamp=Math.min(mag,JR);
  const angle=Math.atan2(joy.dy,joy.dx);
  const cx=Math.cos(angle)*clamp;
  const cy=Math.sin(angle)*clamp;
  jStick.style.transform=`translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px))`;
  jStick.style.boxShadow=`0 0 20px ${G.avatar.aura}`;
}
function joyEnd(e){
  e.preventDefault();
  joy.active=false; joy.dx=0; joy.dy=0;
  jStick.style.transform='translate(-50%,-50%)';
  jStick.style.boxShadow='0 0 15px rgba(0,212,255,0.6)';
}

jZone.addEventListener('touchstart',joyStart,{passive:false});
document.addEventListener('touchmove',joyMove,{passive:false});
document.addEventListener('touchend',joyEnd,{passive:false});
jZone.addEventListener('mousedown',joyStart);
document.addEventListener('mousemove',e=>{
  curEl.style.left=e.clientX+'px'; curEl.style.top=e.clientY+'px';
  if(joy.active) joyMove(e);
});
document.addEventListener('mouseup',joyEnd);

// Sprint button
let sprintHeld=false;
document.getElementById('btnSprint').addEventListener('touchstart',e=>{e.preventDefault();sprintHeld=true;});
document.getElementById('btnSprint').addEventListener('touchend',e=>{e.preventDefault();sprintHeld=false;});
document.getElementById('btnSprint').addEventListener('mousedown',()=>sprintHeld=true);
document.getElementById('btnSprint').addEventListener('mouseup',()=>sprintHeld=false);

// Interact button
document.getElementById('btnInteract').addEventListener('touchstart',e=>{e.preventDefault();keys['KeyE']=true;setTimeout(()=>keys['KeyE']=false,300);});
document.getElementById('btnInteract').addEventListener('click',()=>{keys['KeyE']=true;setTimeout(()=>keys['KeyE']=false,300);});

// Custom button
document.getElementById('btnCustom').addEventListener('click',openCustomizer);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOMIZER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildColorPicker(containerId, colorKey, colors){
  const el=document.getElementById(containerId);
  el.innerHTML='';
  colors.forEach(c=>{
    const btn=document.createElement('div');
    btn.className='cBtn'+(G.avatar[colorKey]===c?' sel':'');
    btn.style.background=c; btn.style.boxShadow=`0 0 8px ${c}`;
    btn.onclick=()=>{
      G.avatar[colorKey]=c;
      el.querySelectorAll('.cBtn').forEach(b=>b.classList.remove('sel'));
      btn.classList.add('sel');
      renderCharPreview();
    };
    el.appendChild(btn);
  });
}

function buildShapePicker(){
  const el=document.getElementById('shapes'); el.innerHTML='';
  SHAPES.forEach(sh=>{
    const btn=document.createElement('div');
    btn.className='sBtn'+(G.avatar.shape===sh?' sel':'');
    btn.textContent=sh;
    btn.onclick=()=>{
      G.avatar.shape=sh;
      el.querySelectorAll('.sBtn').forEach(b=>b.classList.remove('sel'));
      btn.classList.add('sel');
      renderCharPreview();
    };
    el.appendChild(btn);
  });
}

function buildAccPicker(){
  const el=document.getElementById('accessories'); el.innerHTML='';
  ACCS.forEach(a=>{
    const btn=document.createElement('div');
    btn.className='sBtn'+(G.avatar.acc===a?' sel':'');
    btn.textContent=a;
    btn.onclick=()=>{
      G.avatar.acc=a;
      el.querySelectorAll('.sBtn').forEach(b=>b.classList.remove('sel'));
      btn.classList.add('sel');
      renderCharPreview();
    };
    el.appendChild(btn);
  });
}

function renderCharPreview(){
  const pc=document.getElementById('charPreviewCanvas');
  const pctx=pc.getContext('2d');
  pctx.clearRect(0,0,120,180);

  const cx=60,cy=130;

  // Shadow
  pctx.fillStyle='rgba(0,0,0,0.3)';
  pctx.beginPath(); pctx.ellipse(cx,cy+5,15,6,0,0,Math.PI*2); pctx.fill();

  // Aura
  const gr=pctx.createRadialGradient(cx,cy-20,0,cx,cy-20,50);
  gr.addColorStop(0,G.avatar.aura+'44'); gr.addColorStop(1,'transparent');
  pctx.fillStyle=gr; pctx.beginPath(); pctx.arc(cx,cy-20,50,0,Math.PI*2); pctx.fill();

  // Body
  pctx.shadowColor=G.avatar.aura; pctx.shadowBlur=20;
  pctx.fillStyle=G.avatar.color;
  if(G.avatar.shape==='carr√©') pctx.fillRect(cx-14,cy-36,28,28);
  else if(G.avatar.shape==='rond'){pctx.beginPath();pctx.arc(cx,cy-22,15,0,Math.PI*2);pctx.fill();}
  else{pctx.save();pctx.translate(cx,cy-22);pctx.rotate(Math.PI/4);pctx.fillRect(-12,-12,24,24);pctx.restore();}

  // Head
  pctx.fillStyle=lightenColor(G.avatar.color,30);
  pctx.beginPath(); pctx.arc(cx,cy-50,12,0,Math.PI*2); pctx.fill();

  // Eyes
  pctx.fillStyle='#000';
  pctx.fillRect(cx-6,cy-54,4,4);
  pctx.fillRect(cx+2,cy-54,4,4);

  // Acc preview
  const savedShadow=pctx.shadowBlur;
  if(G.avatar.acc==='couronne'){
    pctx.fillStyle='#ffdd00'; pctx.shadowColor='#ffdd00'; pctx.shadowBlur=10;
    pctx.beginPath(); pctx.moveTo(cx-12,cy-63); pctx.lineTo(cx-12,cy-72); pctx.lineTo(cx-6,cy-67); pctx.lineTo(cx,cy-75); pctx.lineTo(cx+6,cy-67); pctx.lineTo(cx+12,cy-72); pctx.lineTo(cx+12,cy-63); pctx.closePath(); pctx.fill();
  } else if(G.avatar.acc==='ailes'){
    pctx.fillStyle=G.avatar.aura+'99'; pctx.shadowColor=G.avatar.aura; pctx.shadowBlur=12;
    pctx.beginPath(); pctx.moveTo(cx,cy-40); pctx.bezierCurveTo(cx-40,cy-65,cx-50,cy-30,cx-25,cy-35); pctx.closePath(); pctx.fill();
    pctx.beginPath(); pctx.moveTo(cx,cy-40); pctx.bezierCurveTo(cx+40,cy-65,cx+50,cy-30,cx+25,cy-35); pctx.closePath(); pctx.fill();
  } else if(G.avatar.acc==='casque'){
    pctx.fillStyle='#888'; pctx.shadowColor='#aaa'; pctx.shadowBlur=8;
    pctx.beginPath(); pctx.arc(cx,cy-60,13,Math.PI,0); pctx.fill();
    pctx.fillStyle=G.avatar.aura; pctx.fillRect(cx-2,cy-74,4,8);
  }
  pctx.shadowBlur=0;
}

function openCustomizer(){
  buildColorPicker('bodyColors','color',COLORS.player);
  buildColorPicker('auraColors','aura',COLORS.aura);
  buildShapePicker();
  buildAccPicker();
  renderCharPreview();
  document.getElementById('customizer').classList.add('open');
}
function closeCustomizer(){
  document.getElementById('customizer').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START SCREEN SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildStartColors(){
  const el=document.getElementById('startColors');
  COLORS.player.forEach(c=>{
    const btn=document.createElement('div');
    btn.className='cpBtn'+(G.avatar.color===c?' sel':'');
    btn.style.background=c; btn.style.boxShadow=`0 0 8px ${c}`;
    btn.onclick=()=>{
      G.avatar.color=c; G.avatar.aura=c;
      el.querySelectorAll('.cpBtn').forEach(b=>b.classList.remove('sel'));
      btn.classList.add('sel');
    };
    el.appendChild(btn);
  });
}

// Animated start background
let sbParticles=[];
for(let i=0;i<80;i++){
  sbParticles.push({x:Math.random()*2000,y:Math.random()*1200,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,r:1+Math.random()*2,color:`hsl(${Math.random()*360},100%,70%)`});
}

function animateStartBg(){
  if(document.getElementById('startScreen').style.display==='none') return;
  sbCtx.fillStyle='rgba(0,2,10,0.15)';
  sbCtx.fillRect(0,0,startBg.width,startBg.height);

  sbParticles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0)p.x=startBg.width; if(p.x>startBg.width)p.x=0;
    if(p.y<0)p.y=startBg.height; if(p.y>startBg.height)p.y=0;
    sbCtx.fillStyle=p.color; sbCtx.shadowColor=p.color; sbCtx.shadowBlur=6;
    sbCtx.beginPath(); sbCtx.arc(p.x,p.y,p.r,0,Math.PI*2); sbCtx.fill();
    sbCtx.shadowBlur=0;
  });

  // Grid lines
  sbCtx.strokeStyle='rgba(0,100,200,0.05)'; sbCtx.lineWidth=1;
  const ts=80;
  for(let x=0;x<startBg.width;x+=ts){ sbCtx.beginPath(); sbCtx.moveTo(x,0); sbCtx.lineTo(x,startBg.height); sbCtx.stroke(); }
  for(let y=0;y<startBg.height;y+=ts){ sbCtx.beginPath(); sbCtx.moveTo(0,y); sbCtx.lineTo(startBg.width,y); sbCtx.stroke(); }

  requestAnimationFrame(animateStartBg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKGROUND FX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawBg(){
  ctx.fillStyle='#000408';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Stars
  const t=performance.now();
  for(let i=0;i<5;i++){
    ctx.fillStyle='rgba(255,255,255,'+(0.2+Math.random()*0.3)+')';
    ctx.fillRect(
      (i*373+t*0.005)%canvas.width,
      (i*197+t*0.003)%canvas.height,
      1,1
    );
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gameStarted=false;

function gameLoop(t){
  drawBg();
  drawFloor();
  drawZoneLabels();

  // Sort & draw (buildings behind npcs behind player)
  drawBuildings();
  drawCollectibles(t);
  drawNPCs(t);
  drawPlayer(t);
  drawParticles();
  drawFloatTexts();
  drawMinimap();

  updatePlayer();
  tickNotif();

  requestAnimationFrame(gameLoop);
}

function startGame(){
  const nameVal=document.getElementById('sName').value.trim();
  G.playerName=nameVal||'Joueur';
  document.getElementById('startScreen').style.display='none';
  initWorld();
  requestAnimationFrame(gameLoop);
}

document.getElementById('sName').addEventListener('keydown',e=>{ if(e.key==='Enter') startGame(); });

buildStartColors();
animateStartBg();
</script>

</body>
</html>
