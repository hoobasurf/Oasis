<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>OASIS ‚Äî Monde du Ciel</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Nunito',sans-serif;}
#gc{position:fixed;top:0;left:0;touch-action:none;}
#hud{position:fixed;top:14px;left:0;width:100%;display:flex;justify-content:center;gap:10px;z-index:20;pointer-events:none;}
.hchip{background:rgba(255,255,255,0.92);border-radius:30px;padding:7px 18px;font-size:13px;font-weight:800;color:#3a2a6a;box-shadow:0 4px 18px rgba(100,80,200,0.18);border:2.5px solid rgba(255,255,255,0.9);}
.hchip span{color:#7c5ce8;}
#zonename{position:fixed;top:58px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:800;color:rgba(80,60,160,0.6);letter-spacing:3px;text-transform:uppercase;pointer-events:none;z-index:20;}
/* Mobile joystick */
#jzone{position:fixed;bottom:50px;left:20px;width:110px;height:110px;z-index:30;display:none;touch-action:none;}
#jbase{position:absolute;inset:0;border-radius:50%;background:rgba(255,255,255,0.3);border:3px solid rgba(255,255,255,0.6);backdrop-filter:blur(4px);}
#jknob{position:absolute;width:44px;height:44px;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff,#b0a0f0);border:2px solid rgba(255,255,255,0.8);box-shadow:0 4px 14px rgba(100,80,200,0.4);}
@media(pointer:coarse){#jzone{display:block;}}
#hint{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);font-size:10px;color:rgba(80,60,160,0.4);letter-spacing:2px;font-weight:700;pointer-events:none;}
@media(pointer:coarse){#hint{display:none;}}
#notif{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.96);border-radius:20px;padding:14px 28px;font-size:15px;font-weight:800;color:#3a2a6a;text-align:center;pointer-events:none;opacity:0;z-index:60;box-shadow:0 8px 32px rgba(100,80,200,0.25);max-width:80vw;}
</style>
</head>
<body>
<canvas id="gc"></canvas>
<div id="hud">
  <div class="hchip">‚ù§Ô∏è <span id="hpv">100</span></div>
  <div class="hchip">üí∞ <span id="goldv">0</span></div>
  <div class="hchip">‚≠ê <span id="lvlv">1</span></div>
</div>
<div id="zonename" id="znlbl">√éle des Nuages</div>
<div id="notif" id="notifEl"></div>
<div id="jzone"><div id="jbase"></div><div id="jknob"></div></div>
<div id="hint">ZQSD ¬∑ SAUTER: ESPACE/W ¬∑ COURIR: TOUJOURS</div>

<script>
(function(){
"use strict";

// ‚îÄ‚îÄ Canvas
var GC=document.getElementById("gc"),C=GC.getContext("2d");
function resize(){GC.width=window.innerWidth;GC.height=window.innerHeight;}
resize();window.addEventListener("resize",resize);

// ‚îÄ‚îÄ URL params
var P={};try{window.location.search.slice(1).split("&").forEach(function(s){var kv=s.split("=");if(kv[0])P[kv[0]]=decodeURIComponent(kv[1]||"");});}catch(e){}
var PNAME=P["name"]||"Joueur";

// ‚îÄ‚îÄ Game state
var G={gold:0,hp:100,lvl:1,xp:0,xpMax:100};

// ‚îÄ‚îÄ World
var WW=6000,WH=800; // horizontal scrolling world
var CAM={x:0,y:0};

// ‚îÄ‚îÄ Player (always auto-sprint)
var PL={
  x:200,y:300,
  vx:0,vy:0,
  w:36,h:52,
  onGround:false,
  dir:1,
  frame:0,
  frameT:0,
  jumpPressed:false,
  bouncing:false
};
var SPEED=4.2; // auto-run speed
var JUMP=-16;
var GRAV=0.68;
var MAX_FALL=22;

var KEYS={};
var joyDX=0,joyDY=0,joyActive=false;

// ‚ïê‚ïê WORLD GEOMETRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Platforms: {x,y,w,h, type: "grass"|"cloud"|"wood"|"gem"}
var PLATFORMS=[];
// Bridges: {x1,y,x2, planks}
var BRIDGES=[];
// Collectibles
var COINS=[];
// NPCs/Signs
var SIGNS=[];
// Decorations
var CLOUDS_BG=[];
var ISLANDS=[];

function worldBuild(){
  // ‚îÄ‚îÄ STARTING ISLAND ‚Äî big grassy island
  platRange(0,520,700,60,"grass","√éle de D√©part");
  platRange(50,460,120,18,"flower");
  platRange(200,450,80,18,"flower");

  // ‚îÄ‚îÄ GAP then small cloud platforms
  platRange(750,490,120,20,"cloud");
  platRange(920,450,100,20,"cloud");
  platRange(1060,410,130,20,"cloud");

  // ‚îÄ‚îÄ SECOND ISLAND (wood bridges from here)
  platRange(1200,520,500,55,"grass","√éle des Ponts");
  platRange(1220,460,90,18,"flower");

  // Bridge from second island east edge to third
  bridge(1700,510,2100);

  // ‚îÄ‚îÄ THIRD ISLAND ‚Äî gem island
  platRange(2100,520,400,55,"gem","√éle des Cristaux");
  platRange(2120,450,60,15,"gem");
  platRange(2250,400,60,15,"gem");
  platRange(2380,370,60,15,"gem");

  // Cloud staircase up
  platRange(2550,430,90,20,"cloud");
  platRange(2680,380,90,20,"cloud");
  platRange(2810,330,90,20,"cloud");
  platRange(2940,290,100,20,"cloud");

  // ‚îÄ‚îÄ FOURTH ISLAND ‚Äî high up
  platRange(3050,270,550,55,"grass","√éle C√©leste");
  platRange(3070,200,80,18,"flower");
  platRange(3220,180,80,18,"flower");

  // Bridge across gap
  bridge(3600,285,4000);

  // ‚îÄ‚îÄ FIFTH ‚Äî sunset island
  platRange(4000,300,450,55,"sunset","√éle du Coucher");
  platRange(4020,230,70,16,"flower");

  // Descend via clouds
  platRange(4500,350,100,20,"cloud");
  platRange(4640,400,100,20,"cloud");
  platRange(4780,450,100,20,"cloud");

  // ‚îÄ‚îÄ SIXTH ‚Äî floating gem platform
  platRange(4900,480,300,55,"gem","√éle des √âtoiles");
  platRange(5050,410,80,16,"gem");

  // Bridge to final
  bridge(5200,490,5600);

  // ‚îÄ‚îÄ FINAL ISLAND
  platRange(5600,500,380,60,"grass","√éle Finale");
  platRange(5620,430,90,18,"flower");

  // Coins scattered
  spawnCoins();

  // Background clouds (decorative, not platforms)
  for(var i=0;i<50;i++){
    CLOUDS_BG.push({
      x:Math.random()*WW,
      y:60+Math.random()*380,
      w:80+Math.random()*200,
      h:45+Math.random()*80,
      spd:0.15+Math.random()*0.4,
      alpha:0.55+Math.random()*0.4,
      puff:Math.random()>0.5
    });
  }

  // Signs / NPCs
  SIGNS.push({x:350,y:500,msg:"Cours vers la droite ! ‚Üí",col:"#7c5ce8"});
  SIGNS.push({x:1350,y:495,msg:"Saute sur les nuages ! ‚òÅ",col:"#00b4d8"});
  SIGNS.push({x:2200,y:495,msg:"Les cristaux donnent des ‚ú¶ !",col:"#f72585"});
  SIGNS.push({x:3150,y:245,msg:"Tu touches les √©toiles !",col:"#f4a261"});
  SIGNS.push({x:4100,y:275,msg:"Magnifique Coucher... ‚òÄ",col:"#e76f51"});
  SIGNS.push({x:5650,y:475,msg:"Tu as atteint la fin ! üèÜ",col:"#7c5ce8"});
}

function platRange(x,y,w,h,type,name){
  PLATFORMS.push({x:x,y:y,w:w,h:h,type:type,name:name||null});
}

function bridge(x1,y,x2){
  var nPlanks=Math.floor((x2-x1)/32);
  BRIDGES.push({x1:x1,y:y,x2:x2,planks:nPlanks});
  // Bridge acts as thin platform
  PLATFORMS.push({x:x1,y:y-8,w:x2-x1,h:8,type:"bridge"});
}

function spawnCoins(){
  // Coins above platforms
  PLATFORMS.forEach(function(p){
    if(p.type==="bridge"||p.type==="flower") return;
    var n=Math.floor(p.w/60);
    for(var i=0;i<n;i++){
      var cx=p.x+30+i*(p.w-60)/(Math.max(1,n-1));
      var type=p.type==="gem"?"gem":"gold";
      COINS.push({x:cx,y:p.y-30,type:type,val:type==="gem"?5:1,pulse:Math.random()*Math.PI*2,done:false});
    }
  });
}

worldBuild();

// ‚ïê‚ïê DRAWING HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hexRgb(h){return[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];}
function clr(h,n){var c=hexRgb(h);return"rgb("+Math.max(0,c[0]+n)+","+Math.max(0,c[1]+n)+","+Math.max(0,c[2]+n)+")";}

// Sky gradient ‚Äî shifts from dawn to dusk across world
function drawSky(){
  var prog=Math.max(0,Math.min(1,(PL.x-0)/(WW-800)));
  // Dawn: #87ceeb‚Üí#b8d8f8 / Noon: #4fc3f7‚Üí#81d4fa / Dusk: #ffb347‚Üí#ff6b6b
  var r1=Math.round(135+prog*120);var g1=Math.round(206-prog*100);var b1=Math.round(235-prog*170+prog*prog*60);
  var r2=Math.round(184+prog*71);var g2=Math.round(216-prog*140);var b2=Math.round(248-prog*200);
  var sky=C.createLinearGradient(0,0,0,GC.height);
  sky.addColorStop(0,"rgb("+r1+","+g1+","+b1+")");
  sky.addColorStop(0.6,"rgb("+r2+","+g2+","+b2+")");
  sky.addColorStop(1,"rgb("+(r2-20)+","+(g2-10)+","+(b2+10)+")");
  C.fillStyle=sky;C.fillRect(0,0,GC.width,GC.height);

  // Sun or gradient glow
  var sx=GC.width*(1-prog)+GC.width*prog*0.2+prog*GC.width*0.7;
  var sy=GC.height*0.12+prog*GC.height*0.3;
  var sg=C.createRadialGradient(sx,sy,0,sx,sy,prog>0.5?180:220);
  var sunCol=prog>0.6?"rgba(255,160,80,0.5)":"rgba(255,240,180,0.45)";
  sg.addColorStop(0,sunCol);sg.addColorStop(1,"transparent");
  C.fillStyle=sg;C.fillRect(0,0,GC.width,GC.height);

  // Sun disc
  C.save();C.shadowColor=prog>0.6?"#ffb347":"#fff8dc";C.shadowBlur=40;
  C.fillStyle=prog>0.6?"#ffcf77":"#fffde7";
  C.beginPath();C.arc(sx,sy,prog>0.6?38:28,0,Math.PI*2);C.fill();
  C.restore();
}

// Fluffy cloud drawing
function drawCloud(x,y,w,h,alpha,puff){
  C.save();C.globalAlpha=alpha;
  var puffs=puff?7:5;
  var pw=w/puffs*1.4;
  for(var i=0;i<puffs;i++){
    var px=x+i*(w/puffs)-pw*0.15;
    var py=y+Math.sin(i/puffs*Math.PI)*(-h*0.28);
    var pr=(h*0.38+Math.sin(i*2.1)*h*0.12);
    var cg=C.createRadialGradient(px+pw*0.5,py,0,px+pw*0.5,py,pw*0.65);
    cg.addColorStop(0,"rgba(255,255,255,1)");
    cg.addColorStop(0.5,"rgba(240,248,255,0.95)");
    cg.addColorStop(1,"rgba(220,235,255,0.0)");
    C.fillStyle=cg;
    C.beginPath();C.ellipse(px+pw*0.5,py,pw*0.65,pr,0,0,Math.PI*2);C.fill();
  }
  // Bottom flat
  var bg=C.createLinearGradient(x,y+h*0.2,x,y+h*0.7);
  bg.addColorStop(0,"rgba(255,255,255,0.85)");
  bg.addColorStop(1,"rgba(200,220,255,0.15)");
  C.fillStyle=bg;
  C.beginPath();C.ellipse(x+w*0.5,y+h*0.4,w*0.48,h*0.32,0,0,Math.PI);C.fill();
  C.restore();
}

// Platform drawing
function drawPlatform(p){
  var sx=p.x-CAM.x,sy=p.y-CAM.y;
  if(sx+p.w<-60||sx>GC.width+60) return;
  if(p.type==="bridge") return; // drawn separately

  var prog=Math.max(0,Math.min(1,(PL.x-0)/(WW-800)));

  if(p.type==="cloud"){
    // Fluffy cloud platform
    drawCloud(sx,sy-18,p.w,32,1,false);
    // Soft shadow
    C.save();C.globalAlpha=0.12;C.fillStyle="#8090c0";
    C.beginPath();C.ellipse(sx+p.w/2,sy+p.h+10,p.w*0.4,8,0,0,Math.PI*2);C.fill();
    C.restore();
    return;
  }

  if(p.type==="gem"||p.type==="crystal"){
    // Crystal/gem platform
    var gg=C.createLinearGradient(sx,sy,sx,sy+p.h);
    gg.addColorStop(0,"#c77dff");gg.addColorStop(0.4,"#9b5de5");gg.addColorStop(1,"#6a0572");
    // Platform body
    C.fillStyle=gg;
    C.beginPath();C.roundRect(sx,sy+6,p.w,p.h-6,8);C.fill();
    // Crystal top surface
    var topG=C.createLinearGradient(sx,sy,sx+p.w,sy+8);
    topG.addColorStop(0,"#e0aaff");topG.addColorStop(0.5,"#c77dff");topG.addColorStop(1,"#9b5de5");
    C.fillStyle=topG;
    C.beginPath();C.roundRect(sx,sy,p.w,12,8);C.fill();
    // Gems on top
    var ng=Math.floor(p.w/45);
    for(var i=0;i<ng;i++){
      var gx=sx+22+i*(p.w-44)/(Math.max(1,ng-1));
      var gy=sy-6;
      drawGem(gx,gy,8);
    }
    // Side shadow
    C.fillStyle="rgba(60,0,80,0.25)";
    C.beginPath();C.roundRect(sx,sy+p.h-8,p.w,8,{lowerLeft:8,lowerRight:8});C.fill();
    return;
  }

  if(p.type==="sunset"){
    var sg2=C.createLinearGradient(sx,sy,sx,sy+p.h);
    sg2.addColorStop(0,"#f4a261");sg2.addColorStop(0.4,"#e76f51");sg2.addColorStop(1,"#c1440e");
    C.fillStyle=sg2;C.beginPath();C.roundRect(sx,sy+6,p.w,p.h-6,8);C.fill();
    var st=C.createLinearGradient(sx,sy,sx+p.w,sy+10);
    st.addColorStop(0,"#ffd166");st.addColorStop(0.5,"#f4a261");st.addColorStop(1,"#e76f51");
    C.fillStyle=st;C.beginPath();C.roundRect(sx,sy,p.w,12,8);C.fill();
    drawGrass(sx,sy,p.w,"#ffd166","#f4a261");
    return;
  }

  if(p.type==="flower"){
    // Thin decorative ledge with flowers
    C.fillStyle="#a8e063";C.beginPath();C.roundRect(sx,sy,p.w,p.h,6);C.fill();
    var nf=Math.floor(p.w/22);
    for(var i=0;i<nf;i++){drawFlower(sx+11+i*22,sy-8);}
    return;
  }

  // ‚îÄ‚îÄ GRASS PLATFORM (default)
  // Shadow underneath
  C.save();C.globalAlpha=0.18;C.fillStyle="#2a4a00";
  C.beginPath();C.ellipse(sx+p.w/2,sy+p.h+8,p.w*0.42,10,0,0,Math.PI*2);C.fill();
  C.restore();

  // Platform body (dirt/stone)
  var soil=C.createLinearGradient(sx,sy+14,sx,sy+p.h);
  soil.addColorStop(0,"#c9a96e");soil.addColorStop(1,"#a0784a");
  C.fillStyle=soil;C.beginPath();C.roundRect(sx,sy+14,p.w,p.h-14,{lowerLeft:10,lowerRight:10});C.fill();

  // Soil texture dots
  C.save();C.globalAlpha=0.12;C.fillStyle="#7a5a30";
  for(var i=0;i<Math.floor(p.w/18);i++){
    C.beginPath();C.arc(sx+9+i*18,sy+p.h-14,5,0,Math.PI*2);C.fill();
  }
  C.restore();

  // Grass top ‚Äî bumpy
  drawGrass(sx,sy,p.w,"#6abe30","#92d050");

  // Flowers on top
  if(p.w>120){
    var nf2=Math.floor(p.w/90);
    for(var i=0;i<nf2;i++){
      drawFlower(sx+50+i*(p.w-100)/Math.max(1,nf2-1),sy-2);
    }
  }
  // Pebble decorations on side
  C.save();C.globalAlpha=0.3;C.fillStyle="#8B7355";
  for(var i=0;i<Math.floor(p.w/40);i++){
    C.beginPath();C.ellipse(sx+20+i*40,sy+p.h-8,6,4,0.3,0,Math.PI*2);C.fill();
  }
  C.restore();

  // Bottom edge darker
  C.fillStyle="rgba(80,50,20,0.22)";C.beginPath();C.roundRect(sx,sy+p.h-8,p.w,8,{lowerLeft:10,lowerRight:10});C.fill();
}

function drawGrass(sx,sy,w,col1,col2){
  // Bumpy grass top
  var gg=C.createLinearGradient(sx,sy,sx+w*0.5,sy+12);
  gg.addColorStop(0,col1);gg.addColorStop(1,col2);
  C.fillStyle=gg;
  C.beginPath();
  C.moveTo(sx,sy+14);
  // Bumps
  var bumpW=w/Math.max(1,Math.round(w/18));
  for(var i=0;i<=Math.round(w/bumpW);i++){
    var bx=sx+i*bumpW;
    var bh=4+Math.sin(i*1.8)*3;
    C.quadraticCurveTo(bx-bumpW*0.5,sy-bh,bx,sy+4);
  }
  C.lineTo(sx+w,sy+16);C.closePath();C.fill();
}

function drawGem(x,y,r){
  C.save();C.shadowColor="#e040fb";C.shadowBlur=10;
  var gg=C.createRadialGradient(x-r*0.3,y-r*0.4,0,x,y,r);
  gg.addColorStop(0,"#f0a0ff");gg.addColorStop(0.5,"#c77dff");gg.addColorStop(1,"#7b2d8b");
  C.fillStyle=gg;
  C.beginPath();
  C.moveTo(x,y-r);C.lineTo(x+r*0.8,y-r*0.2);C.lineTo(x+r*0.6,y+r);C.lineTo(x-r*0.6,y+r);C.lineTo(x-r*0.8,y-r*0.2);
  C.closePath();C.fill();
  C.fillStyle="rgba(255,255,255,0.55)";C.beginPath();C.moveTo(x-r*0.1,y-r*0.9);C.lineTo(x+r*0.4,y-r*0.1);C.lineTo(x,y+r*0.1);C.closePath();C.fill();
  C.restore();
}

function drawFlower(x,y){
  var cols=["#ff6b9d","#ffd93d","#ff8c42","#6bcb77","#4d96ff"];
  var col=cols[Math.floor(x*0.037)%cols.length];
  C.save();
  // Petals
  for(var i=0;i<5;i++){
    var a=(Math.PI*2/5)*i;
    C.fillStyle=col;C.beginPath();C.ellipse(x+Math.cos(a)*4,y+Math.sin(a)*4,3.5,2.5,a,0,Math.PI*2);C.fill();
  }
  // Center
  C.fillStyle="#ffd93d";C.beginPath();C.arc(x,y,2.5,0,Math.PI*2);C.fill();
  C.restore();
}

function drawBridge(b){
  var x1=b.x1-CAM.x,x2=b.x2-CAM.x,y=b.y-CAM.y;
  if(x2<-60||x1>GC.width+60) return;

  var len=b.x2-b.x1;
  var planks=b.planks;

  // Ropes (catenary curve)
  C.save();
  C.strokeStyle="#8B6F47";C.lineWidth=3.5;
  C.shadowColor="#5a3e1e";C.shadowBlur=4;
  for(var side=0;side<2;side++){
    var oy=side===0?-18:-14;
    C.beginPath();
    C.moveTo(x1,y+oy);
    for(var t=0;t<=1;t+=0.02){
      var bx=x1+(x2-x1)*t;
      var by=y+oy+Math.sin(t*Math.PI)*22; // catenary sag
      C.lineTo(bx,by);
    }
    C.stroke();
  }
  C.shadowBlur=0;

  // Vertical ropes every 4 planks
  C.strokeStyle="#A0826D";C.lineWidth=1.8;
  for(var i=1;i<planks-1;i+=4){
    if(i%4===0||true){
      var px=x1+(i/planks)*(x2-x1);
      var t2=i/planks;
      var ropeSag=Math.sin(t2*Math.PI)*22;
      C.beginPath();C.moveTo(px,y-18+ropeSag);C.lineTo(px,y-2);C.stroke();
    }
  }

  // Planks
  for(var i=0;i<planks;i++){
    var px2=x1+(i+0.5)/planks*(x2-x1);
    var pw=Math.floor((x2-x1)/planks)-1;
    if(pw<4)pw=4;
    // Plank color alternating slightly
    C.fillStyle=i%3===0?"#c49a6c":"#d4a97a";
    C.save();
    C.shadowColor="rgba(0,0,0,0.15)";C.shadowBlur=2;
    C.beginPath();
    C.roundRect(px2-pw/2,y-6,pw,9,2);
    C.fill();
    // Plank highlight
    C.fillStyle="rgba(255,255,255,0.18)";C.beginPath();C.roundRect(px2-pw/2+1,y-6,pw-2,3,1);C.fill();
    C.restore();
    // Grain lines
    C.strokeStyle="rgba(120,70,20,0.2)";C.lineWidth=0.7;
    C.beginPath();C.moveTo(px2-pw/2+2,y-4);C.lineTo(px2-pw/2+2,y+2);C.stroke();
  }

  // Anchor posts at ends
  for(var side2=0;side2<2;side2++){
    var ax=side2===0?x1:x2;
    C.fillStyle="#7a5c38";
    C.beginPath();C.roundRect(ax-5,y-35,10,38,4);C.fill();
    C.fillStyle="#9b7a50";C.beginPath();C.roundRect(ax-7,y-38,14,8,3);C.fill();
    // Rope tie
    C.strokeStyle="#6a4f2a";C.lineWidth=2;
    C.beginPath();C.arc(ax,y-35,5,0,Math.PI*2);C.stroke();
  }
}

// ‚îÄ‚îÄ CHARACTER DRAWING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawChar(x,y,dir,frame,skin,cloth,hair){
  var s=dir; // 1=right, -1=left
  var f=frame%8; // walk frame
  var ls=Math.sin(f/8*Math.PI*2)*10; // leg swing
  var as=-Math.sin(f/8*Math.PI*2)*7; // arm swing

  C.save();C.translate(x,y);if(s<0)C.scale(-1,1);

  // Shadow
  C.fillStyle="rgba(0,0,0,0.15)";C.beginPath();C.ellipse(0,2,16,5,0,0,Math.PI*2);C.fill();

  // Aura / speed lines when running
  if(frame>0){
    C.save();C.globalAlpha=0.18;C.strokeStyle="#fff";C.lineWidth=2;
    for(var i=0;i<3;i++){
      C.beginPath();C.moveTo(-20-i*8,ls*0.2-10+i*8);C.lineTo(-34-i*6,ls*0.2-10+i*8);C.stroke();
    }
    C.restore();
  }

  // Legs
  C.fillStyle=cloth==="#7c5ce8"?"#5a3fa8":dk(cloth,30);
  // Left leg (front)
  C.save();C.translate(-6,-22);C.rotate(ls*0.05);
  C.beginPath();C.roundRect(-5,0,10,24,4);C.fill();
  // Shoe
  C.fillStyle="#2a1a0a";C.beginPath();C.roundRect(-6,22,14,7,3);C.fill();
  C.restore();
  // Right leg (back)
  C.save();C.translate(6,-22);C.rotate(-ls*0.05);
  C.fillStyle=dk(cloth,40);C.beginPath();C.roundRect(-5,0,10,24,4);C.fill();
  C.fillStyle="#2a1a0a";C.beginPath();C.roundRect(-6,22,14,7,3);C.fill();
  C.restore();

  // Body / shirt
  var bg=C.createLinearGradient(-13,-52,13,-52);
  bg.addColorStop(0,lt(cloth,25));bg.addColorStop(0.5,cloth);bg.addColorStop(1,dk(cloth,20));
  C.fillStyle=bg;C.beginPath();C.roundRect(-13,-52,26,32,6);C.fill();
  // Shirt detail
  C.fillStyle="rgba(255,255,255,0.15)";C.beginPath();C.roundRect(-10,-50,6,20,3);C.fill();

  // Arms
  // Left arm
  C.save();C.translate(-15,-46);C.rotate(as*0.05+0.1);
  C.fillStyle=dk(cloth,20);C.beginPath();C.roundRect(-4,0,9,20,4);C.fill();
  C.fillStyle=skin;C.beginPath();C.ellipse(0,21,4,5,0,0,Math.PI*2);C.fill();
  C.restore();
  // Right arm
  C.save();C.translate(15,-46);C.rotate(-as*0.05-0.1);
  C.fillStyle=dk(cloth,10);C.beginPath();C.roundRect(-5,0,9,20,4);C.fill();
  C.fillStyle=skin;C.beginPath();C.ellipse(0,21,4,5,0,0,Math.PI*2);C.fill();
  C.restore();

  // Neck
  C.fillStyle=skin;C.fillRect(-4,-56,8,7);

  // HEAD
  C.save();C.translate(0,-68);
  var hg=C.createRadialGradient(-4,-4,0,0,0,15);
  hg.addColorStop(0,lt(skin,40));hg.addColorStop(1,dk(skin,5));
  C.fillStyle=hg;C.shadowColor="rgba(0,0,0,0.2)";C.shadowBlur=6;
  C.beginPath();C.ellipse(0,0,13,15,0,0,Math.PI*2);C.fill();C.shadowBlur=0;

  // Cheeks
  C.fillStyle="rgba(255,120,100,0.2)";
  C.beginPath();C.ellipse(-7,4,5,3.5,0,0,Math.PI*2);C.fill();
  C.beginPath();C.ellipse(7,4,5,3.5,0,0,Math.PI*2);C.fill();

  // Eyes
  C.fillStyle="#fff";C.beginPath();C.ellipse(-5,-3,5,6,0,0,Math.PI*2);C.fill();
  C.beginPath();C.ellipse(5,-3,5,6,0,0,Math.PI*2);C.fill();
  C.fillStyle="#2a1a5e";C.beginPath();C.arc(-5,-3,3.2,0,Math.PI*2);C.fill();
  C.beginPath();C.arc(5,-3,3.2,0,Math.PI*2);C.fill();
  C.fillStyle="#fff";C.beginPath();C.arc(-3.5,-5,1.1,0,Math.PI*2);C.fill();
  C.beginPath();C.arc(6.5,-5,1.1,0,Math.PI*2);C.fill();
  // Eyelash
  C.strokeStyle="#1a0a3e";C.lineWidth=1.2;
  C.beginPath();C.arc(-5,-3,5.5,Math.PI+0.2,-0.2);C.stroke();
  C.beginPath();C.arc(5,-3,5.5,Math.PI+0.2,-0.2);C.stroke();
  // Smile
  C.strokeStyle=dk(skin,22);C.lineWidth=1.4;
  C.beginPath();C.arc(0,6,3.5,0.2,Math.PI-0.2);C.stroke();

  // Hair
  C.fillStyle=hair;C.shadowColor=hair;C.shadowBlur=3;
  C.beginPath();C.ellipse(0,-3,13,9,0,Math.PI,0);C.fill();
  C.fillRect(-13,-3,26,5);
  // Side bangs
  C.beginPath();C.ellipse(-12,3,5,8,0.3,0,Math.PI*2);C.fill();
  C.shadowBlur=0;
  C.restore();

  // Name tag above
  C.font="bold 9px Nunito,sans-serif";C.textAlign="center";
  C.fillStyle="rgba(50,30,100,0.55)";
  var tw=C.measureText(PNAME).width+10;
  C.beginPath();C.roundRect(-tw/2,-94,tw,14,4);C.fill();
  C.fillStyle="#fff";C.fillText(PNAME,0,-83);
  C.textAlign="left";

  C.restore();
}

function lt(h,n){var c=hexRgb(h);return"rgb("+Math.min(255,c[0]+n)+","+Math.min(255,c[1]+n)+","+Math.min(255,c[2]+n)+")";}
function dk(h,n){var c=hexRgb(h);return"rgb("+Math.max(0,c[0]-n)+","+Math.max(0,c[1]-n)+","+Math.max(0,c[2]-n)+")";}

// ‚îÄ‚îÄ COINS ‚îÄ‚îÄ
var PARTS=[],FLOATS=[];
function drawCoins(){
  COINS.forEach(function(cn){
    if(cn.done)return;
    cn.pulse+=0.07;
    var sx=cn.x-CAM.x,sy=cn.y-CAM.y+Math.sin(cn.pulse*0.7)*5;
    if(sx<-40||sx>GC.width+40)return;
    // Coin
    var r=cn.type==="gem"?9:7;
    var mc=cn.type==="gem"?"#e040fb":"#ffd700";
    var ec=cn.type==="gem"?"#880088":"#b8860b";
    var tilt=Math.abs(Math.cos(cn.pulse*0.9));
    var rx=Math.max(1,r*tilt);
    // Glow
    C.save();C.shadowColor=mc;C.shadowBlur=12;
    var fg=C.createRadialGradient(-rx*0.3,-r*0.3,0,0,0,r);
    fg.addColorStop(0,cn.type==="gem"?"#f8a0ff":"#fff8c0");
    fg.addColorStop(0.5,mc);fg.addColorStop(1,ec);
    C.save();C.translate(sx,sy);
    if(tilt>0.1){
      C.fillStyle=ec;C.beginPath();C.ellipse(0,r*0.18*tilt,rx,r,0,0,Math.PI);C.fill();
    }
    C.fillStyle=fg;C.beginPath();C.ellipse(0,0,rx,r,0,0,Math.PI*2);C.fill();
    C.strokeStyle=ec;C.lineWidth=1;C.beginPath();C.ellipse(0,0,rx,r,0,0,Math.PI*2);C.stroke();
    if(rx>4){
      C.fillStyle="rgba(255,255,255,0.55)";
      C.beginPath();C.ellipse(-rx*0.32,-r*0.32,rx*0.25,r*0.12,-0.4,0,Math.PI*2);C.fill();
    }
    C.restore();C.shadowBlur=0;
    // Collect?
    var dx=PL.x-cn.x,dy=(PL.y-30)-cn.y;
    if(dx*dx+dy*dy<38*38){
      cn.done=true;
      G.gold+=cn.val;
      document.getElementById("goldv").textContent=G.gold;
      addXP(cn.type==="gem"?15:5);
      addFloat(sx,sy,"+"+(cn.type==="gem"?"5 ‚ú¶":"1 ‚ú¶"),cn.type==="gem"?"#e040fb":"#ffd700");
      spawnBurst(sx,sy,mc,8);
    }
  });
}

function spawnBurst(x,y,col,n){
  for(var i=0;i<n;i++){var a=(Math.PI*2/n)*i;PARTS.push({x:x,y:y,vx:Math.cos(a)*(1.5+Math.random()*3),vy:Math.sin(a)*(1.5+Math.random()*3),c:col,life:55,max:55,r:2+Math.random()*3});}
}
function addFloat(x,y,txt,col){FLOATS.push({x:x,y:y,txt:txt,col:col,life:80,max:80,vy:-1.3});}

function drawParts(){
  for(var i=PARTS.length-1;i>=0;i--){
    var p=PARTS[i];p.x+=p.vx;p.y+=p.vy;p.vx*=0.92;p.vy*=0.92;p.life--;
    if(p.life<=0){PARTS.splice(i,1);continue;}
    C.globalAlpha=p.life/p.max;C.fillStyle=p.c;C.shadowColor=p.c;C.shadowBlur=5;
    C.beginPath();C.arc(p.x,p.y,p.r,0,Math.PI*2);C.fill();
  }C.globalAlpha=1;C.shadowBlur=0;
}
function drawFloats(){
  for(var i=FLOATS.length-1;i>=0;i--){
    var f=FLOATS[i];f.y+=f.vy;f.life--;
    if(f.life<=0){FLOATS.splice(i,1);continue;}
    C.globalAlpha=f.life/f.max;C.fillStyle=f.col;C.shadowColor=f.col;C.shadowBlur=5;
    C.font="bold 12px Nunito,sans-serif";C.textAlign="center";C.fillText(f.txt,f.x,f.y);
  }C.globalAlpha=1;C.shadowBlur=0;C.textAlign="left";
}

// ‚îÄ‚îÄ Signs
function drawSigns(){
  SIGNS.forEach(function(sg){
    var sx=sg.x-CAM.x,sy=sg.y-CAM.y;
    if(sx<-200||sx>GC.width+200)return;
    // Post
    C.fillStyle="#8B6F47";C.beginPath();C.roundRect(sx-4,sy-55,8,55,2);C.fill();
    // Board
    C.fillStyle="#fffde7";C.shadowColor="rgba(0,0,0,0.15)";C.shadowBlur=8;
    C.beginPath();C.roundRect(sx-55,sy-78,110,28,6);C.fill();C.shadowBlur=0;
    C.strokeStyle=sg.col;C.lineWidth=2;C.beginPath();C.roundRect(sx-55,sy-78,110,28,6);C.stroke();
    C.font="bold 10px Nunito,sans-serif";C.textAlign="center";C.fillStyle=sg.col;
    C.fillText(sg.msg,sx,sy-59);C.textAlign="left";
    // Near player?
    var dx=PL.x-sg.x;
    if(dx*dx<120*120){
      C.save();C.globalAlpha=0.7;C.font="bold 9px Nunito,sans-serif";C.textAlign="center";
      C.fillStyle=sg.col;C.fillText("‚ñ≤",sx,sy-86);C.restore();
    }
  });
}

// ‚îÄ‚îÄ XP
function addXP(n){
  G.xp+=n;
  if(G.xp>=G.xpMax){G.xp=0;G.lvl++;G.xpMax=Math.floor(G.xpMax*1.4);document.getElementById("lvlv").textContent=G.lvl;notify("üéâ Niveau "+G.lvl+" !","#7c5ce8");spawnBurst(GC.width/2,GC.height/2,"#7c5ce8",20);}
}

var notifT=0;
function notify(txt,col){
  var el=document.getElementById("notifEl");el.textContent=txt;el.style.borderLeft="4px solid "+(col||"#7c5ce8");el.style.opacity="1";notifT=200;
}

// ‚îÄ‚îÄ PHYSICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getTopPlatformAt(px,py){
  // Find highest platform the player is standing on
  var best=null,bestY=Infinity;
  PLATFORMS.forEach(function(p){
    if(px+PL.w*0.4>p.x&&px-PL.w*0.4<p.x+p.w){
      var top=p.y;
      if(py>=top-4&&py<=top+30&&top<bestY){
        bestY=top;best=p;
      }
    }
  });
  return best;
}

var T=0;
function update(){
  T++;
  // ‚îÄ‚îÄ INPUT
  // Horizontal: joystick OR keyboard, but always auto-run right if no input
  var inputX=0,inputJump=false;
  if(KEYS["KeyZ"]||KEYS["ArrowUp"]||KEYS["Space"]||KEYS["KeyW"])inputJump=true;
  if(KEYS["KeyQ"]||KEYS["ArrowLeft"])inputX=-1;
  if(KEYS["KeyD"]||KEYS["ArrowRight"])inputX=1;
  if(joyActive){
    if(Math.abs(joyDX)>10)inputX=joyDX>0?1:-1;
    if(joyDY<-20)inputJump=true;
  }

  // Auto-run: always move right if no explicit left
  if(inputX===0)inputX=1; // auto-sprint right
  if(inputX>0)PL.dir=1;else if(inputX<0)PL.dir=-1;

  PL.vx=inputX*SPEED;

  // Jump
  if(inputJump&&PL.onGround&&!PL.jumpPressed){
    PL.vy=JUMP;PL.onGround=false;PL.jumpPressed=true;
  }
  if(!inputJump)PL.jumpPressed=false;

  // Gravity
  PL.vy+=GRAV;if(PL.vy>MAX_FALL)PL.vy=MAX_FALL;

  // Move
  PL.x+=PL.vx;PL.y+=PL.vy;

  // Bounds
  PL.x=Math.max(0,Math.min(WW-PL.w,PL.x));
  if(PL.y>WH+300){PL.y=100;PL.vy=0;G.hp=Math.max(20,G.hp-10);document.getElementById("hpv").textContent=G.hp;notify("A√Øe ! Tu es tomb√© !","#e74c3c");}

  // Platform collision
  PL.onGround=false;
  PLATFORMS.forEach(function(p){
    var pleft=p.x,pright=p.x+p.w,ptop=p.y,pbot=p.y+p.h;
    var cleft=PL.x-PL.w*0.38,cright=PL.x+PL.w*0.38;
    // Only land on top
    if(cright>pleft&&cleft<pright){
      if(PL.vy>=0&&PL.y+4>=ptop&&PL.y-PL.vy<=ptop+8){
        PL.y=ptop;PL.vy=0;PL.onGround=true;
      }
    }
  });

  // Animation
  if(PL.onGround&&PL.vx!==0){PL.frameT++;if(PL.frameT%5===0)PL.frame++;}
  else if(!PL.onGround){PL.frameT=0;}

  // Zone names
  var zname="Ciel Ouvert";
  PLATFORMS.forEach(function(p){if(p.name&&PL.x>p.x&&PL.x<p.x+p.w&&PL.y<=p.y+10)zname=p.name;});
  document.getElementById("znlbl").textContent=zname;

  // Camera
  var targetX=PL.x-GC.width*0.35;
  var targetY=PL.y-GC.height*0.55;
  CAM.x+=(targetX-CAM.x)*0.1;
  CAM.y+=(targetY-CAM.y)*0.1;
  CAM.x=Math.max(-GC.width*0.1,Math.min(WW-GC.width,CAM.x));
  CAM.y=Math.max(-200,Math.min(WH-GC.height,CAM.y));
}

// ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loop(t){
  // SKY
  drawSky();

  // Background clouds (parallax)
  CLOUDS_BG.forEach(function(cl){
    cl.x-=cl.spd;if(cl.x+cl.w<-100)cl.x=WW+100;
    var sx=cl.x-CAM.x*0.3; // parallax 0.3
    var sy=cl.y-CAM.y*0.15;
    if(sx+cl.w>-60&&sx<GC.width+60)drawCloud(sx,sy,cl.w,cl.h,cl.alpha,cl.puff);
  });

  // Platforms (back to front)
  PLATFORMS.slice().sort(function(a,b){return a.y-b.y;}).forEach(drawPlatform);

  // Bridges
  BRIDGES.forEach(drawBridge);

  // Signs
  drawSigns();

  // Coins
  drawCoins();

  // Player
  var sx=PL.x-CAM.x,sy=PL.y-CAM.y;
  drawChar(sx,sy,PL.dir,PL.frame,"#FDDBB4","#7c5ce8","#3D1C02");

  // Particles / floats
  drawParts();drawFloats();

  // Notification
  if(notifT>0){notifT--;document.getElementById("notifEl").style.opacity=notifT<60?(notifT/60).toFixed(2):"1";}

  update();
  requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ
document.addEventListener("keydown",function(e){KEYS[e.code]=true;e.preventDefault&&["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)&&e.preventDefault();});
document.addEventListener("keyup",function(e){KEYS[e.code]=false;});

// Joystick
var jzone=document.getElementById("jzone"),jknob=document.getElementById("jknob");
var joyStartX=0,joyStartY=0;var JR=42;
function jStart(e){e.preventDefault();var r=jzone.getBoundingClientRect();joyActive=true;joyStartX=r.left+r.width/2;joyStartY=r.top+r.height/2;}
function jMove2(e){if(!joyActive)return;var t=e.touches?e.touches[0]:e;joyDX=t.clientX-joyStartX;joyDY=t.clientY-joyStartY;var m=Math.sqrt(joyDX*joyDX+joyDY*joyDY),cl=Math.min(m,JR),a=Math.atan2(joyDY,joyDX);jknob.style.transform="translate(calc(-50% + "+Math.cos(a)*cl+"px),calc(-50% + "+Math.sin(a)*cl+"px))";}
function jEnd2(){joyActive=false;joyDX=0;joyDY=0;jknob.style.transform="translate(-50%,-50%)";}
jzone.addEventListener("touchstart",jStart,{passive:false});
document.addEventListener("touchmove",jMove2,{passive:false});
document.addEventListener("touchend",jEnd2);

// Launch
notify("Bienvenue dans le Monde du Ciel, "+PNAME+" ! ‚òÅ","#7c5ce8");
requestAnimationFrame(loop);
})();
</script>

</body>
</html>
